/* CDP-Template 2015-03-31 */
!function(a,b){"function"==typeof define&&define.amd?define(["cdp.tools"],function(){return b(a.CDP||(a.CDP={}))}):b(a.CDP||(a.CDP={}))}(this,function(a){a.Tools=a.Tools||{};var a;!function(a){var b;!function(a){a.INVALID_INDEX=-1}(b=a.Tools||(a.Tools={}))}(a||(a={}));var a;!function(a){var b;!function(a){var b="[CDP.Tools.CursorArray] ",c=function(){function c(b,c){this._array=null,this._index=a.INVALID_INDEX,this._accesser=null,this.setArray(b,c)}return c.prototype.setArray=function(a,c){return a instanceof Array&&0!==a.length?(this.reset(),this._array=a,this._index=0,c&&(this._accesser=c),!0):(console.error(b+"target is not valid array."),this.reset(),!1)},Object.defineProperty(c.prototype,"accesser",{get:function(){return this._accesser},set:function(a){this._accesser=a},enumerable:!0,configurable:!0}),c.prototype.hasAsyncAccesser=function(){return this._accesser?!!this._accesser.async:!1},c.prototype.get=function(a){var b=this.getData(a);return null!=b&&this._accesser?this._accesser(b):b},c.prototype.getData=function(c){return this.valid()?(c=null!=c?c:this._index,a.INVALID_INDEX===c||0>c||this.size()-1<c?(console.error(b+"invalid range. index: "+c),null):this._array[c]):null},c.prototype.remove=function(c){return this.valid()?(c=null!=c?c:this._index,a.INVALID_INDEX===c||0>c||this.size()-1<c?(console.error(b+"invalid range. index: "+c),!1):(this._array.splice(c,1),!0)):!1},c.prototype.size=function(){return this.valid()?this._array.length:0},c.prototype.getIndex=function(){return this._index},c.prototype.getArray=function(a){return void 0===a&&(a=!1),this.valid()?a?this._array:this._array.slice(0):null},c.prototype.isFirst=function(){return this.valid()?0===this._index:!1},c.prototype.isLast=function(){return this.valid()?this._array.length-1===this._index:!1},c.prototype.seek=function(a){return this.valid()?a>=0&&a<this._array.length?(this._index=a,this.get()):(console.error(b+"invalid index range."),null):null},c.prototype.first=function(){return this.seek(0)},c.prototype.last=function(){return this.valid()?this.seek(this._array.length-1):null},c.prototype.previous=function(){return this.valid()?this._index<=0?null:(this._index--,this.get()):null},c.prototype.next=function(){return this.valid()?this._array.length-1<=this._index?null:(this._index++,this.get()):null},c.prototype.reset=function(){this._array=null,this._index=a.INVALID_INDEX},c.prototype.valid=function(){return!!this._array},c}();a.CursorArray=c}(b=a.Tools||(a.Tools={}))}(a||(a={}));var a;return function(a){var b;!function(a){var b="[CDP.Tools.InfinityContainer] ",c=function(){function c(){this._globalIndex=a.INVALID_INDEX,this._prevData=null,this._currentData=null,this._nextData=null,this._settings=null,this._prmsManager=null,this._reservedSeek=[]}return c.prototype.init=function(c,d){var e=null,f=null,g={propAccesser:null,globalContainerMax:null,localContainerMax:null,setupContainer:null,repeat:!1,firstContainerStart:0,firstContainerEnd:null,firstContainerPosition:0};return this.reset(),c instanceof Array?(d&&null!=d.propAccesser&&(f=d.propAccesser),e=new a.CursorArray(c,f)):c instanceof a.CursorArray&&(e=c),e&&e.valid()?(this._settings=$.extend({},g,d),this._settings.globalContainerMax||(this._settings.globalContainerMax=e.size()),this._settings.localContainerMax||(this._settings.localContainerMax=e.size()),this._settings.firstContainerEnd=this._settings.firstContainerStart+e.size()-1,this._currentData={container:e,start:this._settings.firstContainerStart,end:this._settings.firstContainerEnd,dirty:!1},this._globalIndex=this._settings.firstContainerPosition,this.manageState(this.prepareReservedContainers())):(console.error(b+"invalid firstContainer."),$.Deferred().reject())},c.prototype.valid=function(){return this.validContainer(this._currentData,!0)&&this._currentData.start<=this._globalIndex&&this._globalIndex<=this._currentData.end?!0:!1},c.prototype.isInAsyncProc=function(){return 0<this._prmsManager.promises().length?!0:!1},c.prototype.waitAsyncProc=function(){var b=this,c=$.Deferred(),d=function(){var e=b._prmsManager.promises();0<e.length?a.wait(e).always(function(){setTimeout(d)}):c.resolve()};return setTimeout(d),c.promise()},c.prototype.hasAsyncAccesser=function(){return this.valid()?this._currentData.container.hasAsyncAccesser():!1},c.prototype.get=function(a){if(!this.validContainer(this._currentData,!0))return null;var c=null!=a?a:this._globalIndex,d=this.checkIterateRange(c);return d.canSync?d.container.container.seek(d.localIndex):(console.error(b+"cannot sync access, invalid range. index[current:set] = ["+this._globalIndex+":"+c+"]"),null)},c.prototype.remove=function(a){var c=this;if(!this.validContainer(this._currentData,!0))return!1;var d=null!=a?a:this._globalIndex,e=function(a,b){if(c.validContainer(a,!0)&&c.validContainer(b,!0)&&a.end<b.start){var d=b.container.getArray(!0).shift();a.container.getArray(!0).push(d),b.dirty=!0,a.dirty=a.container.size()!==c._settings.localContainerMax}else a.dirty=!0},f=function(){var a=function(a){return c.validContainer(a,!0)&&a.container.size()<=0?!1:!0};a(c._prevData)||(c._prevData=c.resetContainer()),c.valid()&&a(c._currentData)||(c._currentData=c.resetContainer()),a(c._nextData)||(c._nextData=c.resetContainer())},g=function(a){switch(a){case"backward":e(c._prevData,c._currentData),e(c._currentData,c._nextData);break;case"":e(c._currentData,c._nextData);break;case"forward":c._nextData.dirty=!0}f(),c.validContainer(c._currentData,!0)?c.validContainer(c._prevData)||c.validContainer(c._nextData,!0)?c.validContainer(c._prevData)?c.validContainer(c._nextData,!0)||c.manageState(c.prepareForwardContainer()):c.manageState(c.prepareBackwardContainer()):c.manageState(c.prepareReservedContainers()):c.manageState(c.requeryContainers(c._globalIndex))},h=function(a){var b=0!==c._currentData.start||c._currentData.end!==c._settings.globalContainerMax;b?g(a.shift):c._currentData.end--},i=this.checkIterateRange(d);return i.canSync?i.container.container.remove(i.localIndex)?(this._settings.globalContainerMax--,this._settings.globalContainerMax<=this._globalIndex&&(this._globalIndex=this._settings.globalContainerMax-1),0<this._settings.globalContainerMax?h(i):(this._prevData=this.resetContainer(),this._currentData=this.resetContainer(),this._nextData=this.resetContainer()),!0):!1:(console.error(b+"cannot sync access, invalid range. index[current:set] = ["+this._globalIndex+":"+d+"]"),!1)},c.prototype.size=function(){return this._settings.globalContainerMax},c.prototype.getIndex=function(){return this._globalIndex},c.prototype.getCurrentCursorArray=function(){return this.valid()?(this._currentData.container.seek(this._globalIndex-this._currentData.start),this._currentData.container):null},c.prototype.getCurrentArray=function(){return this.valid()?this._currentData.container.getArray():null},c.prototype.setRepeat=function(a){this._settings.repeat=a,!this.validContainer(this._currentData)||this.validContainer(this._prevData)&&this.validContainer(this._nextData)||this.manageState(this.prepareReservedContainers())},c.prototype.isRepeatable=function(){return this._settings.repeat},c.prototype.isFirst=function(a){void 0===a&&(a=!1);var b=!a&&this._settings.repeat;return!this.valid()||b?!1:0===this._globalIndex},c.prototype.isLast=function(a){void 0===a&&(a=!1);var b=!a&&this._settings.repeat;return!this.valid()||b?!1:this._settings.globalContainerMax-1===this._globalIndex},c.prototype.seek=function(a){var c=this,d=$.Deferred(),e={succeeded:!1,promise:null,value:null};if(!this.validContainer(this._currentData,!0)||0>a||this._settings.globalContainerMax-1<a)return console.error(b+"invalid state."),e.promise=$.Deferred().reject(),e;e.promise=d.promise(),e.succeeded=!0;var f=this.checkIterateRange(a);if(f.canSync&&!f.container.dirty){switch(this._globalIndex=a,e.value=f.container.container.seek(f.localIndex),f.shift){case"backward":this.manageState(this.shiftBackwardContainer());break;case"forward":this.manageState(this.shiftForwardContainer())}e.promise=d.resolve(a)}else{this._reservedSeek.push({index:a,df:d});var g=function(){c.waitAsyncProc().always(function(){var a;if(!(c._reservedSeek.length<=0)){a=c._reservedSeek.shift();var d=c.checkIterateRange(a.index);if(d.canSync&&!d.container.dirty){switch(c._globalIndex=a.index,d.shift){case"backward":c.manageState(c.shiftBackwardContainer());break;case"forward":c.manageState(c.shiftForwardContainer())}return a.df.resolve(a.index),void(0<c._reservedSeek.length&&setTimeout(g,0))}c.manageState(c.requeryContainers(a.index)).then(function(){c._globalIndex=a.index,a.df.resolve(a.index),0<c._reservedSeek.length&&setTimeout(g,0)}).fail(function(){console.error(b+"queryContainer(), failed."),a.df.reject(a.index),0<c._reservedSeek.length&&setTimeout(g,0)})}})};g()}return e},c.prototype.first=function(){return this.seek(0)},c.prototype.last=function(){return this.seek(this._settings.globalContainerMax-1)},c.prototype.previous=function(){var a=this._globalIndex-1;if(0>a){if(!this._settings.repeat)return{succeeded:!1,promise:$.Deferred().reject(),value:null};a=this._settings.globalContainerMax-1}return this.seek(a)},c.prototype.next=function(){var a=this._globalIndex+1;if(this._settings.globalContainerMax<=a){if(!this._settings.repeat)return{succeeded:!1,promise:$.Deferred().reject(),value:null};a=0}return this.seek(a)},c.prototype.updateSetupContainer=function(a,c){return!this.valid()||this.isInAsyncProc()?!1:"function"!=typeof a?(console.error(b+"invalid function type."),!1):(this._settings.setupContainer=a,c&&(this.updateAccesser(this._prevData,c),this.updateAccesser(this._currentData,c),this.updateAccesser(this._nextData,c)),!0)},c.prototype.clone=function(){if(!this.valid())return null;var a=$.extend(!0,{},this);return a._prevData.container=$.extend(!0,{},this._prevData.container),a._currentData.container=$.extend(!0,{},this._currentData.container),a._nextData.container=$.extend(!0,{},this._nextData.container),a},c.prototype.reset=function(){this._globalIndex=a.INVALID_INDEX,this._prevData=this.resetContainer(),this._currentData=this.resetContainer(),this._nextData=this.resetContainer(),this._settings=null,this._prmsManager=new a.PromiseManager},c.prototype.resetContainer=function(){return{container:null,start:a.INVALID_INDEX,end:a.INVALID_INDEX,dirty:!1}},c.prototype.updateAccesser=function(a,b){return a&&a.container?(a.container.accesser=b,!0):!1},c.prototype.manageState=function(b){return this._prmsManager.add(a.makePromise(b))},c.prototype.validContainer=function(b,c){return void 0===c&&(c=!1),b&&b.container&&a.INVALID_INDEX!==b.start&&a.INVALID_INDEX!==b.end&&b.start<=b.end?c?!0:!b.dirty:!1},c.prototype.queryContainer=function(c,d,e){var f=$.Deferred(),g=a.INVALID_INDEX,h=a.INVALID_INDEX,i=this._currentData.container?this._currentData.container.accesser:null;if(!this._settings.setupContainer)return console.error(b+"_settings.setupContainer is null."),f.reject();switch(e){case"backward":g=Math.floor(d/this._settings.localContainerMax)*this._settings.localContainerMax,h=d;break;case"forward":g=d,h=d+this._settings.localContainerMax-1;break;default:return console.error(b+"invalid direction: "+e),f.reject()}return this._settings.setupContainer(g,h+1,function(d,j){var k=null;return d instanceof Array?k=new a.CursorArray(d,j?j:i):d instanceof a.CursorArray&&(k=d),k?(c.container=k,"forward"===e?(c.start=g,c.end=g+k.size()-1):(c.start=h-(k.size()-1),c.start<0&&(console.warn(b+"target.start revised."),c.start=0),c.end=h),f.resolve()):(console.error(b+"received container is null."),f.reject())}),f},c.prototype.prepareBackwardContainer=function(){return 0<this._currentData.start?this.queryContainer(this._prevData,this._currentData.start-1,"backward"):0===this._currentData.start&&this._currentData.end<this._settings.globalContainerMax-1&&this._settings.repeat?this.queryContainer(this._prevData,this._settings.globalContainerMax-1,"backward"):$.Deferred().resolve()},c.prototype.prepareForwardContainer=function(){return this._currentData.end<this._settings.globalContainerMax-1?this.queryContainer(this._nextData,this._currentData.end+1,"forward"):this._currentData.end===this._settings.globalContainerMax-1&&0<this._currentData.start&&this._settings.repeat?this.queryContainer(this._nextData,0,"forward"):$.Deferred().resolve()},c.prototype.prepareReservedContainers=function(){var a=$.Deferred(),c=[];return this.validContainer(this._currentData)?(this._prevData=this.resetContainer(),this._nextData=this.resetContainer(),c.push(this.prepareBackwardContainer()),c.push(this.prepareForwardContainer()),$.when.apply(null,c).done(function(){a.resolve()}).fail(function(){console.error(b+"wait queryContainer(), failed."),a.reject()}),a):(console.error(b+"validContainer(_currentData), failed."),a.reject())},c.prototype.requeryContainers=function(a){var b=this,c=$.Deferred(),d=Math.floor(a/this._settings.localContainerMax)*this._settings.localContainerMax;return this._currentData=this.resetContainer(),this.queryContainer(this._currentData,d,"forward").then(function(){return b.prepareReservedContainers()}).then(function(){c.resolve()}).fail(function(){c.reject()}),c},c.prototype.shiftBackwardContainer=function(){return this.validContainer(this._currentData,!0)&&this.validContainer(this._prevData)?($.extend(!0,this._nextData,this._currentData),$.extend(!0,this._currentData,this._prevData),this._prevData=this.resetContainer(),this.prepareBackwardContainer()):(console.error(b+"validContainer(), failed."),$.Deferred().reject())},c.prototype.shiftForwardContainer=function(){return this.validContainer(this._currentData,!0)&&this.validContainer(this._nextData)?($.extend(!0,this._prevData,this._currentData),$.extend(!0,this._currentData,this._nextData),this._nextData=this.resetContainer(),this.prepareForwardContainer()):(console.error(b+"validContainer(), failed."),$.Deferred().reject())},c.prototype.checkIterateRange=function(b){var c={canSync:!1,container:null,localIndex:a.INVALID_INDEX,shift:""};return this.isInRange(b,this._currentData)?(c.canSync=!0,c.container=this._currentData,c.localIndex=b-this._currentData.start,c):this.isInRange(b,this._prevData)?(c.canSync=!0,c.container=this._prevData,c.localIndex=b-this._prevData.start,c.shift="backward",c):this.isInRange(b,this._nextData)?(c.canSync=!0,c.container=this._nextData,c.localIndex=b-this._nextData.start,c.shift="forward",c):c},c.prototype.isInRange=function(a,b){return this.validContainer(b,!0)&&b.start<=a&&a<b.start+b.container.size()?!0:!1},c}();a.InfinityContainer=c}(b=a.Tools||(a.Tools={}))}(a||(a={})),a.Tools});
//# sourceMappingURL=cdp.tools.container-0.3.0.min.map